name: ci
on: [push, pull_request]
jobs:
    build:
        strategy:
            matrix:
                os: [ubuntu-latest, macos-latest, windows-latest]
        runs-on: ${{ matrix.os }}
        steps:
            - uses: actions/checkout@v4
              with:
                  submodules: recursive
                  fetch-depth: 0

            # Windows: set up MSVC environment (adds cl.exe to PATH, sets vars)
            - name: Setup MSVC (Windows)
              if: runner.os == 'Windows'
              uses: ilammy/msvc-dev-cmd@v1
              with:
                  arch: x64

            # Bootstrap vcpkg per-OS (robust shells)
            - name: Bootstrap vcpkg (Unix)
              if: runner.os != 'Windows'
              shell: bash
              run: ./vcpkg/bootstrap-vcpkg.sh

            - name: Bootstrap vcpkg (Windows)
              if: runner.os == 'Windows'
              shell: cmd
              run: .\vcpkg\bootstrap-vcpkg.bat

            - name: CMake version
              run: cmake --version

            - name: Configure
              shell: bash
              run: cmake --preset release

            - name: Build
              shell: bash
              run: cmake --build --preset build-release

            - name: Smoke run (Linux/macOS only)
              if: runner.os != 'Windows'
              shell: bash
              run: ./build/app
